RewriteEngine on

# Collapse multiple slashes (//) in the path
RewriteCond %{THE_REQUEST} \s[^?]*//
RewriteRule ^/?(.*) /$1 [R=301,L]

# Remove www. from url
RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
RewriteRule ^ https://%1%{REQUEST_URI} [R=301,NE,L]

# Set Security Header
Header always set Strict-Transport-Security "max-age=16070400; includeSubDomains" env=HTTPS

# Brotli compression
<IfModule mod_brotli.c>
    SetOutputFilter BROTLI_COMPRESS
</IfModule>

# Sitemap
RewriteRule ^sitemap\.xml$ /code/sitemap.php [L,NC]

# Handle only the category
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^([^/%]+)/?$ index.php?category=$1 [L,QSA,B,UnsafeAllow3F]

# Handle both category and file
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^([^/%]+)/([^/%]+)/?$ index.php?category=$1&file=$2 [L,QSA,B,UnsafeAllow3F]

# Cache images, scripts, stylesheets
<IfModule mod_expires.c>
    ExpiresActive on
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 day"
    ExpiresByType text/javascript "access plus 1 day"
    ExpiresByType text/css "access plus 1 day"
</IfModule>